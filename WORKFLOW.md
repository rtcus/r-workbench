# 🔄 完整工作流程图解

本文档用图解方式说明R跟单台系统的完整工作流程。

## 📊 部署流程图

```
┌─────────────────────────────────────────────────────────────┐
│                      1. 本地开发                            │
│                                                              │
│  ┌──────────┐    ┌──────────┐    ┌──────────┐              │
│  │  编写代码 │───▶│  本地测试 │───▶│  Git提交  │              │
│  └──────────┘    └──────────┘    └──────────┘              │
└──────────────────────────┬──────────────────────────────────┘
                           │
                           │ git push
                           ▼
┌─────────────────────────────────────────────────────────────┐
│                      2. GitHub                               │
│                                                              │
│  ┌──────────────────────────────────────────┐               │
│  │      代码仓库（Private推荐）              │               │
│  │  ✓ 所有代码文件                          │               │
│  │  ✓ 配置文件（不含敏感信息）              │               │
│  │  ✗ .env文件（被.gitignore排除）          │               │
│  └──────────────────────────────────────────┘               │
└──────────────────────────┬──────────────────────────────────┘
                           │
                           │ Webhook触发
                           ▼
┌─────────────────────────────────────────────────────────────┐
│                      3. Vercel                               │
│                                                              │
│  ┌────────────┐    ┌────────────┐    ┌────────────┐        │
│  │  检测更新   │───▶│  自动构建   │───▶│  自动部署   │        │
│  └────────────┘    └────────────┘    └────────────┘        │
│                                                              │
│  ┌─────────────────────────────────────────┐                │
│  │         环境变量（安全存储）             │                │
│  │  • LEANCLOUD_APP_ID                     │                │
│  │  • LEANCLOUD_APP_KEY                    │                │
│  │  • LEANCLOUD_SERVER_URL                 │                │
│  └─────────────────────────────────────────┘                │
└──────────────────────────┬──────────────────────────────────┘
                           │
                           │ 部署成功
                           ▼
┌─────────────────────────────────────────────────────────────┐
│                   4. 生产环境                                │
│                                                              │
│  🌐 https://your-app.vercel.app                             │
│                                                              │
│  ┌─────────────┐        ┌─────────────┐                    │
│  │  静态资源    │        │ Serverless  │                    │
│  │  HTML/CSS/JS│        │  Functions  │                    │
│  └─────────────┘        └─────────────┘                    │
└─────────────────────────────────────────────────────────────┘
```

## 🔐 安全架构流程

```
┌────────────────────────────────────────────────────────┐
│                    用户访问                             │
└────────────────────┬───────────────────────────────────┘
                     │
                     ▼
          ┌──────────────────┐
          │   r-workbench    │
          │      .html       │  ← 前端页面（无敏感信息）
          └────────┬─────────┘
                   │
                   │ 引入 api-client.js
                   ▼
          ┌──────────────────┐
          │   api-client.js  │  ← API客户端
          │                  │    • 封装API调用
          └────────┬─────────┘    • 管理sessionToken
                   │              • 提供AV兼容层
                   │
                   │ POST /api/leancloud
                   │ { action, data }
                   ▼
┌──────────────────────────────────────────────────────────┐
│                    Vercel后端                             │
│                                                           │
│  ┌────────────────────────────────────────────────┐     │
│  │          api/leancloud.js                      │     │
│  │                                                 │     │
│  │  1. 接收前端请求                               │     │
│  │  2. 读取环境变量（安全）                       │     │
│  │  3. 初始化LeanCloud SDK                        │     │
│  │  4. 执行数据库操作                             │     │
│  │  5. 返回结果                                   │     │
│  └────────────────────────────────────────────────┘     │
│                                                           │
│  ┌────────────────────────────────────────────────┐     │
│  │         环境变量（仅后端可见）                 │     │
│  │                                                 │     │
│  │  process.env.LEANCLOUD_APP_ID       ✓ 安全    │     │
│  │  process.env.LEANCLOUD_APP_KEY      ✓ 安全    │     │
│  │  process.env.LEANCLOUD_SERVER_URL   ✓ 安全    │     │
│  └────────────────────────────────────────────────┘     │
└──────────────────────┬───────────────────────────────────┘
                       │
                       │ LeanCloud SDK调用
                       ▼
          ┌────────────────────┐
          │     LeanCloud      │
          │      数据库        │
          └────────────────────┘
```

## 📱 用户请求流程

### 场景1: 用户登录

```
1. 用户输入账号密码
        ↓
2. 前端调用 api.login(username, password)
        ↓
3. APIClient发送POST请求
   URL: /api/leancloud
   Body: {
     action: 'login',
     data: { username, password }
   }
        ↓
4. Vercel Function接收请求
        ↓
5. 调用 AV.User.logIn(username, password)
   （使用环境变量中的配置）
        ↓
6. LeanCloud验证用户
        ↓
7. 返回sessionToken
        ↓
8. 前端保存sessionToken到localStorage
        ↓
9. 登录成功，显示主界面
```

### 场景2: 查询数据

```
1. 用户访问跟单工作台
        ↓
2. 前端调用 api.query('Tracking', conditions, options)
        ↓
3. APIClient发送POST请求
   URL: /api/leancloud
   Body: {
     action: 'query',
     data: {
       className: 'Tracking',
       conditions: { billNo: 'BILL123' },
       options: { limit: 20 },
       sessionToken: 'xxx'
     }
   }
        ↓
4. Vercel Function接收请求
        ↓
5. 恢复用户会话
   AV.User.become(sessionToken)
        ↓
6. 构建并执行查询
   const query = new AV.Query('Tracking')
   query.equalTo('billNo', 'BILL123')
   query.limit(20)
   const results = await query.find()
        ↓
7. 格式化数据返回
   { success: true, data: [...] }
        ↓
8. 前端渲染数据到表格
```

### 场景3: 保存数据

```
1. 用户填写表单并点击保存
        ↓
2. 前端调用 api.save('Tracking', data)
        ↓
3. APIClient发送POST请求
   URL: /api/leancloud
   Body: {
     action: 'save',
     data: {
       className: 'Tracking',
       data: { containerNo: 'CONT123', ... },
       sessionToken: 'xxx'
     }
   }
        ↓
4. Vercel Function接收请求
        ↓
5. 恢复用户会话
        ↓
6. 创建并保存对象
   const obj = new ObjectClass()
   obj.set('containerNo', 'CONT123')
   await obj.save()
        ↓
7. 返回保存结果
   { success: true, data: { objectId: 'xxx', ... } }
        ↓
8. 前端显示成功提示并刷新列表
```

## 🔄 自动部署流程

```
开发者本地
    │
    │ 1. 编写代码
    ▼
┌─────────┐
│ Git提交 │
└────┬────┘
     │ 2. git commit
     ▼
┌─────────┐
│Git推送  │
└────┬────┘
     │ 3. git push origin main
     ▼
┌──────────────────────────────┐
│         GitHub               │
│  • 接收代码                   │
│  • 更新仓库                   │
│  • 触发Webhook               │
└──────────┬───────────────────┘
           │ 4. 通知Vercel
           ▼
┌──────────────────────────────┐
│         Vercel               │
│                              │
│  Step 1: 检测更新            │
│    ✓ 拉取最新代码             │
│                              │
│  Step 2: 安装依赖            │
│    $ npm install             │
│                              │
│  Step 3: 构建项目            │
│    ✓ 处理静态文件             │
│    ✓ 部署Functions           │
│                              │
│  Step 4: 部署到Edge          │
│    ✓ 全球CDN分发              │
│    ✓ 生成部署URL             │
└──────────┬───────────────────┘
           │ 5. 部署成功
           ▼
┌──────────────────────────────┐
│      生产环境更新             │
│  https://your-app.vercel.app │
└──────────────────────────────┘
           │
           │ 6. 自动通知
           ▼
      开发者邮箱
    "部署成功！"
```

## 🛠️ 本地开发流程

```
1. 克隆项目
   $ git clone <repo-url>
        ↓
2. 安装依赖
   $ npm install
        ↓
3. 配置环境变量
   $ cp .env.example .env.local
   编辑 .env.local 填入配置
        ↓
4. 启动开发服务器
   $ vercel dev
        ↓
5. 访问本地地址
   http://localhost:3000
        ↓
6. 修改代码 → 自动重载 → 测试
   （循环进行）
        ↓
7. 代码完成，提交
   $ git add .
   $ git commit -m "描述"
   $ git push
        ↓
8. Vercel自动部署
```

## 📊 数据流向图

### 完整数据链路

```
┌──────────────────────────────────────────────────────────┐
│                       浏览器                              │
│                                                           │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌─────────┐ │
│  │  UI组件  │─▶│  事件处理 │─▶│API Client│─▶│SessionToken│
│  └──────────┘  └──────────┘  └──────────┘  └─────────┘ │
└────────────────────┬─────────────────────────────────────┘
                     │
                     │ HTTPS POST
                     │ /api/leancloud
                     ▼
┌──────────────────────────────────────────────────────────┐
│                   Vercel Edge Network                     │
│                   （全球CDN加速）                         │
└────────────────────┬─────────────────────────────────────┘
                     │
                     │ 路由到最近节点
                     ▼
┌──────────────────────────────────────────────────────────┐
│               Vercel Serverless Function                 │
│                                                           │
│  ┌──────────────────────────────────────────────┐       │
│  │  1. 解析请求                                 │       │
│  │     { action, data }                         │       │
│  │                                               │       │
│  │  2. 恢复会话                                 │       │
│  │     if (sessionToken) AV.User.become()       │       │
│  │                                               │       │
│  │  3. 执行操作                                 │       │
│  │     switch(action) {                         │       │
│  │       case 'query': handleQuery()            │       │
│  │       case 'save': handleSave()              │       │
│  │       ...                                     │       │
│  │     }                                         │       │
│  │                                               │       │
│  │  4. 返回结果                                 │       │
│  │     { success, data }                        │       │
│  └──────────────────────────────────────────────┘       │
└────────────────────┬─────────────────────────────────────┘
                     │
                     │ LeanCloud REST API
                     ▼
┌──────────────────────────────────────────────────────────┐
│                    LeanCloud平台                         │
│                                                           │
│  ┌────────────┐  ┌────────────┐  ┌────────────┐        │
│  │ User表     │  │ Tracking表 │  │ File存储   │        │
│  └────────────┘  └────────────┘  └────────────┘        │
└──────────────────────────────────────────────────────────┘
```

## 🔄 错误处理流程

```
前端请求
    │
    ▼
API调用
    │
    ├─✓ 成功 ──────────▶ 返回数据 ──▶ 渲染UI
    │
    └─✗ 失败
        │
        ├─ 网络错误
        │   └─▶ 显示"网络连接失败，请检查网络"
        │
        ├─ 401 未授权
        │   └─▶ 清除sessionToken ──▶ 跳转登录页
        │
        ├─ 500 服务器错误
        │   ├─▶ 显示"服务器错误，请稍后重试"
        │   └─▶ 记录错误日志到Vercel
        │
        └─ 其他错误
            └─▶ 显示通用错误提示
```

## 📈 性能优化流程

```
用户请求
    │
    ▼
Vercel Edge Network
    │
    ├─ 静态资源（HTML/CSS/JS）
    │   └─▶ CDN缓存命中 ──▶ 直接返回（超快）
    │
    └─ API请求
        │
        ▼
    最近的Edge节点
        │
        ▼
    Serverless Function
        │
        ├─ 冷启动（首次）
        │   └─▶ 初始化环境（~500ms）
        │
        └─ 热启动（复用）
            └─▶ 直接执行（~50ms）
                │
                ▼
            LeanCloud查询
                │
                ▼
            返回结果（总耗时 < 1s）
```

## 🎯 完整生命周期

```
Day 1: 开发
    ├─ 编写代码
    ├─ 本地测试
    └─ Git提交

Day 1: 部署
    ├─ 推送到GitHub
    ├─ Vercel自动构建
    ├─ 配置环境变量
    └─ 部署成功

Day 2-N: 运营
    ├─ 用户访问
    ├─ 监控日志
    ├─ 性能优化
    └─ 功能迭代

持续: 维护
    ├─ 代码更新（git push → 自动部署）
    ├─ 监控告警（Vercel控制台）
    ├─ 数据备份（LeanCloud）
    └─ 安全审计（定期检查）
```

## 📝 总结

通过以上图解，你应该对整个系统有了清晰的认识：

1. **部署流程**: Git → GitHub → Vercel → 生产环境
2. **安全架构**: 配置隐藏在Vercel后端
3. **数据流向**: 前端 → API客户端 → Serverless → LeanCloud
4. **自动化**: 代码推送自动触发部署
5. **性能优化**: 全球CDN + Edge Network

---

**下一步**: 
- 📖 阅读 [QUICK_START.md](QUICK_START.md) 开始部署
- 🏗️ 查看 [ARCHITECTURE.md](ARCHITECTURE.md) 了解技术细节
- ✅ 使用 [CHECKLIST.md](CHECKLIST.md) 验证部署
